var b=(U,B,c)=>new Promise((h,x)=>{var w=d=>{try{p(c.next(d))}catch(o){x(o)}},s=d=>{try{p(c.throw(d))}catch(o){x(o)}},p=d=>d.done?h(d.value):Promise.resolve(d.value).then(w,s);p((c=c.apply(U,B)).next())});import{v as re,r as k,h as q,i as de,c as D,o as g,J as a,S as n,b as u,G as r,M as E,N as F,T as i,I as ue,aa as pe,V,R as f,H as I,ax as C,k as ce,ay as L,_ as me}from"./index-Cghf-nif.js";import{g as _e,c as ge,a as fe,d as ye}from"./tasks-2eQTdq5x.js";import{g as ve}from"./websites-DS8GTrWO.js";const be={class:"task-manage"},ke={class:"flex flex-wrap items-center gap-4"},xe={class:"flex items-center gap-2"},we={class:"flex items-center gap-2"},Ve={class:"flex items-center gap-2"},Ce={class:"text-sm"},he={class:"mt-4 flex justify-end"},Te=re({name:"TaskManage",__name:"index",setup(U){const B=ce(),c=k(!1),h=k([]),x=k(0),w=k([]),s=q({website_id:"",status:"",page:1,page_size:20}),p=k(!1),d=k(),o=q({website_id:"",strategy:"incremental",depth:3,max_links:1e3}),P={website_id:[{required:!0,message:"请选择网站",trigger:"change"}],strategy:[{required:!0,message:"请选择策略",trigger:"change"}]},W=l=>({pending:"info",running:"warning",completed:"success",failed:"danger",cancelled:""})[l]||"info",G=l=>({pending:"等待中",running:"运行中",completed:"已完成",failed:"失败",cancelled:"已取消"})[l]||l,H=l=>l==="incremental"?"增量":"全量",J=()=>b(null,null,function*(){try{const l=yield ve({status:"active"});l.success&&(w.value=l.data)}catch(l){console.error("加载网站列表失败",l)}}),y=()=>b(null,null,function*(){c.value=!0;try{const l=yield _e(s);l.success&&(h.value=l.data,x.value=l.pagination.total)}catch(l){C.error("加载任务列表失败")}finally{c.value=!1}}),O=()=>{Object.assign(o,{website_id:"",strategy:"incremental",depth:3,max_links:1e3}),p.value=!0},Q=()=>b(null,null,function*(){d.value&&(yield d.value.validate(l=>b(null,null,function*(){if(l)try{yield ge(o),C.success("爬取任务已创建"),p.value=!1,y()}catch(e){C.error(e.message||"创建任务失败")}})))}),A=l=>{B.push(`/crawler/tasks/${l.id}`)},K=l=>`${(l*100).toFixed(2)}%`,$=l=>l?new Date(l).toLocaleString():"-",X=l=>{s.page=l,y()},Y=()=>{s.page=1,y()},Z=()=>{s.website_id="",s.status="",s.page=1,y()},ee=l=>{L.confirm(`确定要取消任务"${l.id}"吗？任务将在下一个检查点停止。`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>b(null,null,function*(){try{yield fe(l.id),C.success("任务取消请求已发送"),y()}catch(e){}})).catch(()=>{})},te=l=>{L.confirm(`确定要删除任务"${l.id}"吗？此操作将同时删除任务的所有日志记录。`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>b(null,null,function*(){try{yield ye(l.id),C.success("任务已删除"),y()}catch(e){}})).catch(()=>{})};return de(()=>{J(),y()}),(l,e)=>{const v=r("el-option"),z=r("el-select"),m=r("el-button"),S=r("el-card"),_=r("el-table-column"),M=r("el-tag"),ae=r("el-table"),le=r("el-pagination"),T=r("el-form-item"),N=r("el-radio"),ne=r("el-radio-group"),R=r("el-input-number"),se=r("el-form"),oe=r("el-dialog"),ie=pe("loading");return g(),D("div",be,[a(S,{class:"mb-4"},{default:n(()=>[u("div",ke,[u("div",xe,[e[9]||(e[9]=u("span",{class:"text-sm whitespace-nowrap"},"网站",-1)),a(z,{modelValue:s.website_id,"onUpdate:modelValue":e[0]||(e[0]=t=>s.website_id=t),placeholder:"请选择网站",style:{width:"200px"},clearable:""},{default:n(()=>[(g(!0),D(E,null,F(w.value,t=>(g(),V(v,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),u("div",we,[e[10]||(e[10]=u("span",{class:"text-sm whitespace-nowrap"},"状态",-1)),a(z,{modelValue:s.status,"onUpdate:modelValue":e[1]||(e[1]=t=>s.status=t),placeholder:"请选择状态",style:{width:"150px"},clearable:""},{default:n(()=>[a(v,{label:"等待中",value:"pending"}),a(v,{label:"运行中",value:"running"}),a(v,{label:"已完成",value:"completed"}),a(v,{label:"失败",value:"failed"}),a(v,{label:"已取消",value:"cancelled"})]),_:1},8,["modelValue"])]),u("div",Ve,[a(m,{type:"primary",onClick:Y},{default:n(()=>e[11]||(e[11]=[i("查询",-1)])),_:1,__:[11]}),a(m,{onClick:Z},{default:n(()=>e[12]||(e[12]=[i("重置",-1)])),_:1,__:[12]}),a(m,{type:"success",onClick:O},{default:n(()=>e[13]||(e[13]=[i("创建任务",-1)])),_:1,__:[13]})])])]),_:1}),a(S,null,{default:n(()=>[ue((g(),V(ae,{data:h.value,stripe:""},{default:n(()=>[a(_,{prop:"id",label:"任务ID",width:"220","show-overflow-tooltip":""}),a(_,{prop:"task_type",label:"类型",width:"80"},{default:n(({row:t})=>[i(f(t.task_type==="manual"?"手动":"定时"),1)]),_:1}),a(_,{prop:"strategy",label:"策略",width:"80"},{default:n(({row:t})=>[a(M,{type:t.strategy==="incremental"?"success":"warning",size:"small"},{default:n(()=>[i(f(H(t.strategy)),1)]),_:2},1032,["type"])]),_:1}),a(_,{prop:"status",label:"状态",width:"100"},{default:n(({row:t})=>[a(M,{type:W(t.status)},{default:n(()=>[i(f(G(t.status)),1)]),_:2},1032,["type"])]),_:1}),a(_,{label:"统计","min-width":"200"},{default:n(({row:t})=>[u("div",Ce,[u("div",null,"总链接: "+f(t.statistics.total_links),1),u("div",null,"新增: "+f(t.statistics.new_links),1),u("div",null,"有效率: "+f(K(t.statistics.valid_rate)),1)])]),_:1}),a(_,{prop:"started_at",label:"开始时间",width:"180"},{default:n(({row:t})=>[i(f($(t.started_at)),1)]),_:1}),a(_,{prop:"completed_at",label:"完成时间",width:"180"},{default:n(({row:t})=>[i(f($(t.completed_at)),1)]),_:1}),a(_,{label:"操作",width:"250",fixed:"right"},{default:n(({row:t})=>[a(m,{type:"primary",size:"small",onClick:j=>A(t)},{default:n(()=>e[14]||(e[14]=[i(" 查看详情 ",-1)])),_:2,__:[14]},1032,["onClick"]),t.status==="running"?(g(),V(m,{key:0,type:"warning",size:"small",onClick:j=>ee(t)},{default:n(()=>e[15]||(e[15]=[i(" 取消 ",-1)])),_:2,__:[15]},1032,["onClick"])):I("",!0),t.status!=="running"?(g(),V(m,{key:1,type:"danger",size:"small",onClick:j=>te(t)},{default:n(()=>e[16]||(e[16]=[i(" 删除 ",-1)])),_:2,__:[16]},1032,["onClick"])):I("",!0)]),_:1})]),_:1},8,["data"])),[[ie,c.value]]),u("div",he,[a(le,{"current-page":s.page,"onUpdate:currentPage":e[2]||(e[2]=t=>s.page=t),"page-size":s.page_size,total:x.value,layout:"total, prev, pager, next, jumper",onCurrentChange:X},null,8,["current-page","page-size","total"])])]),_:1}),a(oe,{modelValue:p.value,"onUpdate:modelValue":e[8]||(e[8]=t=>p.value=t),title:"创建爬取任务",width:"600px","close-on-click-modal":!1},{footer:n(()=>[a(m,{onClick:e[7]||(e[7]=t=>p.value=!1)},{default:n(()=>e[19]||(e[19]=[i("取消",-1)])),_:1,__:[19]}),a(m,{type:"primary",onClick:Q},{default:n(()=>e[20]||(e[20]=[i("确定",-1)])),_:1,__:[20]})]),default:n(()=>[a(se,{ref_key:"formRef",ref:d,model:o,rules:P,"label-width":"120px"},{default:n(()=>[a(T,{label:"选择网站",prop:"website_id"},{default:n(()=>[a(z,{modelValue:o.website_id,"onUpdate:modelValue":e[3]||(e[3]=t=>o.website_id=t),placeholder:"请选择网站",style:{width:"100%"}},{default:n(()=>[(g(!0),D(E,null,F(w.value,t=>(g(),V(v,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(T,{label:"爬取策略",prop:"strategy"},{default:n(()=>[a(ne,{modelValue:o.strategy,"onUpdate:modelValue":e[4]||(e[4]=t=>o.strategy=t)},{default:n(()=>[a(N,{label:"incremental"},{default:n(()=>e[17]||(e[17]=[i("增量爬取（仅爬取新链接）",-1)])),_:1,__:[17]}),a(N,{label:"full"},{default:n(()=>e[18]||(e[18]=[i("全量爬取（重新爬取所有链接）",-1)])),_:1,__:[18]})]),_:1},8,["modelValue"])]),_:1}),a(T,{label:"爬取深度"},{default:n(()=>[a(R,{modelValue:o.depth,"onUpdate:modelValue":e[5]||(e[5]=t=>o.depth=t),min:1,max:10,"controls-position":"right"},null,8,["modelValue"])]),_:1}),a(T,{label:"最大链接数"},{default:n(()=>[a(R,{modelValue:o.max_links,"onUpdate:modelValue":e[6]||(e[6]=t=>o.max_links=t),min:100,max:1e5,step:100,"controls-position":"right"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),$e=me(Te,[["__scopeId","data-v-6d319743"]]);export{$e as default};
