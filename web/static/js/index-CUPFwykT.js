var g=(d,_,p)=>new Promise((w,c)=>{var y=u=>{try{s(p.next(u))}catch(C){c(C)}},k=u=>{try{s(p.throw(u))}catch(C){c(C)}},s=u=>u.done?w(u.value):Promise.resolve(u.value).then(y,k);s((p=p.apply(d,_)).next())});import{aA as U,v as le,r as S,h as E,f as ae,i as se,c as B,o as m,J as l,S as a,b as V,G as r,M as A,N as F,T as n,I as oe,aa as ne,V as T,R as x,p as I,H as L,ax as b,ay as re,_ as de}from"./index-BF9pO7mF.js";import{g as ue}from"./websites-N6czdP2W.js";import{f as W}from"./time-DxhBYzk3.js";const ie=d=>U.request("post","/schedules",{data:d}),me=d=>U.request("get","/schedules",{params:d}),_e=(d,_)=>U.request("patch",`/schedules/${d}`,{data:_}),pe=d=>U.request("delete",`/schedules/${d}`),ce={class:"schedule-manage"},ye={class:"flex flex-wrap items-center gap-4"},fe={class:"flex items-center gap-2"},ge={class:"flex items-center gap-2"},be=le({name:"ScheduleManage",__name:"index",setup(d){const _=S(!1),p=S([]),w=S([]),c=E({website_id:""}),y=S(!1),k=S(),s=E({website_id:"",name:"",schedule_type:"daily",strategy:"incremental",hour:2,day:1}),u=ae(()=>({website_id:[{required:!0,message:"请选择网站",trigger:"change"}],name:[{required:!0,message:"请输入任务名称",trigger:"blur"}],schedule_type:[{required:!0,message:"请选择调度类型",trigger:"change"}],strategy:[{required:!0,message:"请选择爬取策略",trigger:"change"}],hour:[{required:s.schedule_type==="daily"||s.schedule_type==="monthly",message:"请输入小时",trigger:"blur"}],day:[{required:s.schedule_type==="monthly",message:"请输入日期",trigger:"blur"}]})),C=o=>({hourly:"每小时",daily:"每天",monthly:"每月"})[o]||o,j=()=>g(null,null,function*(){try{const o=yield ue({status:"active"});o.success&&(w.value=o.data)}catch(o){console.error("加载网站列表失败",o)}}),v=()=>g(null,null,function*(){_.value=!0;try{const o=yield me(c);o.success&&(p.value=o.data)}catch(o){b.error("加载调度列表失败")}finally{_.value=!1}}),G=()=>{Object.assign(s,{website_id:"",name:"",schedule_type:"daily",strategy:"incremental",hour:2,day:1}),y.value=!0},H=()=>g(null,null,function*(){k.value&&(yield k.value.validate(o=>g(null,null,function*(){if(o)try{yield ie(s),b.success("调度任务已创建"),y.value=!1,v()}catch(e){b.error(e.message||"创建调度失败")}})))}),J=o=>g(null,null,function*(){try{yield _e(o.id,{is_active:!o.is_active}),b.success("状态更新成功"),v()}catch(e){b.error("状态更新失败")}}),O=o=>{re.confirm(`确定要删除调度"${o.name}"吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>g(null,null,function*(){try{yield pe(o.id),b.success("删除成功"),v()}catch(e){b.error("删除失败")}})).catch(()=>{})},Q=()=>{v()},K=()=>{c.website_id="",v()};return se(()=>{j(),v()}),(o,e)=>{const $=r("el-option"),D=r("el-select"),f=r("el-button"),M=r("el-card"),i=r("el-table-column"),N=r("el-tag"),P=r("el-table"),h=r("el-form-item"),X=r("el-input"),q=r("el-radio"),R=r("el-radio-group"),z=r("el-input-number"),Y=r("el-form"),Z=r("el-dialog"),ee=ne("loading");return m(),B("div",ce,[l(M,{class:"mb-4"},{default:a(()=>[V("div",ye,[V("div",fe,[e[9]||(e[9]=V("span",{class:"text-sm whitespace-nowrap"},"网站",-1)),l(D,{modelValue:c.website_id,"onUpdate:modelValue":e[0]||(e[0]=t=>c.website_id=t),placeholder:"请选择网站",style:{width:"200px"},clearable:""},{default:a(()=>[(m(!0),B(A,null,F(w.value,t=>(m(),T($,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),V("div",ge,[l(f,{type:"primary",onClick:Q},{default:a(()=>e[10]||(e[10]=[n("查询",-1)])),_:1,__:[10]}),l(f,{onClick:K},{default:a(()=>e[11]||(e[11]=[n("重置",-1)])),_:1,__:[11]}),l(f,{type:"success",onClick:G},{default:a(()=>e[12]||(e[12]=[n("创建调度",-1)])),_:1,__:[12]})])])]),_:1}),l(M,null,{default:a(()=>[oe((m(),T(P,{data:p.value,stripe:""},{default:a(()=>[l(i,{prop:"name",label:"任务名称","min-width":"150"}),l(i,{prop:"schedule_type",label:"调度类型",width:"100"},{default:a(({row:t})=>[n(x(C(t.schedule_type)),1)]),_:1}),l(i,{prop:"cron_expression",label:"Cron表达式",width:"150"}),l(i,{prop:"strategy",label:"爬取策略",width:"100"},{default:a(({row:t})=>[l(N,{type:t.strategy==="incremental"?"success":"warning",size:"small"},{default:a(()=>[n(x(t.strategy==="incremental"?"增量":"全量"),1)]),_:2},1032,["type"])]),_:1}),l(i,{prop:"is_active",label:"状态",width:"100"},{default:a(({row:t})=>[l(N,{type:t.is_active?"success":"info"},{default:a(()=>[n(x(t.is_active?"激活":"停用"),1)]),_:2},1032,["type"])]),_:1}),l(i,{prop:"next_run_time",label:"下次执行时间",width:"180"},{default:a(({row:t})=>[n(x(I(W)(t.next_run_time)),1)]),_:1}),l(i,{prop:"last_run_time",label:"上次执行时间",width:"180"},{default:a(({row:t})=>[n(x(I(W)(t.last_run_time)),1)]),_:1}),l(i,{label:"操作",width:"200",fixed:"right"},{default:a(({row:t})=>[l(f,{type:t.is_active?"warning":"success",size:"small",onClick:te=>J(t)},{default:a(()=>[n(x(t.is_active?"停用":"激活"),1)]),_:2},1032,["type","onClick"]),l(f,{type:"danger",size:"small",onClick:te=>O(t)},{default:a(()=>e[13]||(e[13]=[n(" 删除 ",-1)])),_:2,__:[13]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[ee,_.value]])]),_:1}),l(Z,{modelValue:y.value,"onUpdate:modelValue":e[8]||(e[8]=t=>y.value=t),title:"创建调度任务",width:"600px","close-on-click-modal":!1},{footer:a(()=>[l(f,{onClick:e[7]||(e[7]=t=>y.value=!1)},{default:a(()=>e[21]||(e[21]=[n("取消",-1)])),_:1,__:[21]}),l(f,{type:"primary",onClick:H},{default:a(()=>e[22]||(e[22]=[n("确定",-1)])),_:1,__:[22]})]),default:a(()=>[l(Y,{ref_key:"formRef",ref:k,model:s,rules:u.value,"label-width":"120px"},{default:a(()=>[l(h,{label:"选择网站",prop:"website_id"},{default:a(()=>[l(D,{modelValue:s.website_id,"onUpdate:modelValue":e[1]||(e[1]=t=>s.website_id=t),placeholder:"请选择网站",style:{width:"100%"}},{default:a(()=>[(m(!0),B(A,null,F(w.value,t=>(m(),T($,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(h,{label:"任务名称",prop:"name"},{default:a(()=>[l(X,{modelValue:s.name,"onUpdate:modelValue":e[2]||(e[2]=t=>s.name=t),placeholder:"请输入任务名称"},null,8,["modelValue"])]),_:1}),l(h,{label:"调度类型",prop:"schedule_type"},{default:a(()=>[l(R,{modelValue:s.schedule_type,"onUpdate:modelValue":e[3]||(e[3]=t=>s.schedule_type=t)},{default:a(()=>[l(q,{label:"hourly"},{default:a(()=>e[14]||(e[14]=[n("每小时",-1)])),_:1,__:[14]}),l(q,{label:"daily"},{default:a(()=>e[15]||(e[15]=[n("每天",-1)])),_:1,__:[15]}),l(q,{label:"monthly"},{default:a(()=>e[16]||(e[16]=[n("每月",-1)])),_:1,__:[16]})]),_:1},8,["modelValue"])]),_:1}),s.schedule_type==="daily"||s.schedule_type==="monthly"?(m(),T(h,{key:0,label:"小时",prop:"hour"},{default:a(()=>[l(z,{modelValue:s.hour,"onUpdate:modelValue":e[4]||(e[4]=t=>s.hour=t),min:0,max:23,"controls-position":"right"},null,8,["modelValue"]),e[17]||(e[17]=V("span",{class:"ml-2 text-gray-500"},"点",-1))]),_:1,__:[17]})):L("",!0),s.schedule_type==="monthly"?(m(),T(h,{key:1,label:"日期",prop:"day"},{default:a(()=>[l(z,{modelValue:s.day,"onUpdate:modelValue":e[5]||(e[5]=t=>s.day=t),min:1,max:31,"controls-position":"right"},null,8,["modelValue"]),e[18]||(e[18]=V("span",{class:"ml-2 text-gray-500"},"号",-1))]),_:1,__:[18]})):L("",!0),l(h,{label:"爬取策略",prop:"strategy"},{default:a(()=>[l(R,{modelValue:s.strategy,"onUpdate:modelValue":e[6]||(e[6]=t=>s.strategy=t)},{default:a(()=>[l(q,{label:"incremental"},{default:a(()=>e[19]||(e[19]=[n("增量爬取",-1)])),_:1,__:[19]}),l(q,{label:"full"},{default:a(()=>e[20]||(e[20]=[n("全量爬取",-1)])),_:1,__:[20]})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])])}}}),we=de(be,[["__scopeId","data-v-23f7c75b"]]);export{we as default};
